<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="description" content=""><meta name="keyword"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta http-equiv="X-UA-Compatible" content="IE=edge"><title>Python rq 轻量级的任务队列</title><link rel="shortcut icon" href="/images/angellist.png" type="image/x-icon"><link href="/styles/site.css" rel="stylesheet"><meta name="generator" content="Hexo 4.2.0"></head><body><header class="container" id="header"><div class="header"><div class="header-left"><div class="avatar"><img src="/images/avatar.jpg"></div><div class="author"><div class="author-name"><a href="/">Ritter</a></div><div class="about-me">Hi~ </div></div></div><div class="header-right"><ul class="navigation"><li><a href="/archives">归档</a></li></ul></div><div class="about-me-mask"><div class="about-me-wrap"><div class="about-me__header"><div class="avatar"><img src="/images/avatar.jpg"></div></div><ul class="socials"><li class="social-item"><span class="label"><img src="/images/socials/github.svg" alt="https://github.com/Ri773r"></span><a href="https://github.com/Ri773r" target="_blank" title="https://github.com/Ri773r">https://github.com/Ri773r</a></li><li class="social-item"><span class="label"><img src="/images/socials/email.svg" alt="610577219@qq.com"></span><span>610577219@qq.com</span></li><li class="social-item"><span class="label"><img src="/images/socials/wechat.svg" alt="Sky610577219"></span><span>Sky610577219</span></li></ul></div></div></div></header><div class="container post"><section class="article"><div class="title">Python rq 轻量级的任务队列</div><div class="date">写于2020年06月27日</div><div class="content"><ul>
<li><a href="#Python-rq-轻量级的任务队列">Python rq 轻量级的任务队列</a><ul>
<li><a href="#安装">安装</a></li>
<li><a href="#Queue-队列">Queue 队列</a></li>
<li><a href="#Job-任务">Job 任务</a></li>
<li><a href="#Worker-工作者">Worker 工作者</a><ul>
<li><a href="#性能优化">性能优化</a></li>
<li><a href="#检索工作者信息">检索工作者信息</a></li>
<li><a href="#使用配置文件">使用配置文件</a></li>
<li><a href="#无工作者模式">无工作者模式</a></li>
</ul>
</li>
<li><a href="#Scheduler-调度器">Scheduler 调度器</a></li>
<li><a href="#Connections-连接">Connections 连接</a></li>
<li><a href="#Job-Registries-任务注册表">Job Registries 任务注册表</a></li>
<li><a href="#Serialize-序列化">Serialize 序列化</a></li>
<li><a href="#Monitoring-监控">Monitoring 监控</a><ul>
<li><a href="#使用RQ-dashboard">使用RQ dashboard</a></li>
<li><a href="#使用CLI工具">使用CLI工具</a></li>
</ul>
</li>
<li><a href="#Exceptions-异常处理">Exceptions 异常处理</a></li>
<li><a href="#单元测试">单元测试</a></li>
<li><a href="#Flask中使用RQ添加上下文">Flask中使用RQ添加上下文</a></li>
</ul>
</li>
</ul>
<h2 id="Python-rq-轻量级的任务队列"><a href="#Python-rq-轻量级的任务队列" class="headerlink" title="Python rq 轻量级的任务队列"></a>Python rq 轻量级的任务队列</h2><p>rq是类celery的一个轻量级的任务队列，但是任务存储后端没有celery丰富，只支持redis，也依赖于redis，不过简单好用。</p>
<h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ pip install rq</span><br></pre></td></tr></table></figure>

<h3 id="Queue-队列"><a href="#Queue-队列" class="headerlink" title="Queue 队列"></a>Queue 队列</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rq <span class="keyword">import</span> Queue</span><br><span class="line"><span class="keyword">from</span> redis <span class="keyword">import</span> Redis</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">foo</span><span class="params">(name)</span>:</span></span><br><span class="line">    print(<span class="string">f"hello <span class="subst">&#123;name&#125;</span>"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建一个redis连接</span></span><br><span class="line">host = <span class="string">"xxx.xxx.x.xxx"</span></span><br><span class="line">port = <span class="number">6379</span></span><br><span class="line">db = <span class="number">0</span></span><br><span class="line">redis_conn = Reids(host=host, port=port, db=db)</span><br><span class="line"><span class="comment"># 创建一个队列</span></span><br><span class="line">q = Queue(<span class="string">"myqueue"</span>, connection=redis_conn)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 任务入队 传递函数引用 </span></span><br><span class="line"><span class="comment"># result_ttl 任务结果存储过期时间 默认500秒 -1 永不过期</span></span><br><span class="line"><span class="comment"># ttl 任务如果在30秒内没有被执行 则会被丢弃 </span></span><br><span class="line"><span class="comment"># fail_ttl 失败任务过期时间 默认1年</span></span><br><span class="line"><span class="comment"># job_timeou 任务执行超时时间 默认180秒</span></span><br><span class="line">job = q.enqueue(foo, <span class="string">"world"</span>, result_ttl=<span class="number">600</span>, ttl=<span class="number">30</span>, fail_ttl=<span class="number">600</span>, job_timeou=<span class="number">600</span>)</span><br><span class="line"><span class="comment"># 如果当前进程无法访问到工作进程函数引用时，可以选择传递字符串</span></span><br><span class="line"><span class="comment"># job = q.enqueue(“mypackage.mymodule.foo”, "world")</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># enqueue函数除了可以接收函数引用和字符串引用，也可以直接接收Job实例</span></span><br><span class="line"><span class="comment"># from rq.job import Job</span></span><br><span class="line"><span class="comment"># job = Job.create(foo, "world", id="job_id")</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取队列长度</span></span><br><span class="line">print(len(q))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取队列所有任务id</span></span><br><span class="line">print(q.job_ids)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取队列所有任务实例</span></span><br><span class="line">print(q.jobs)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取队列指定ID的任务实例</span></span><br><span class="line">job = q.fetch_job(<span class="string">"job_id"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 清空队列 将会删除队列内所有任务</span></span><br><span class="line">q.empty()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除队列 delete_jobs参数将会删除所有任务</span></span><br><span class="line"><span class="comment"># 删除后队列将不可用 可以通过enqueue将任务重新入队创建</span></span><br><span class="line">q.delete(delete_jobs=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>

<h3 id="Job-任务"><a href="#Job-任务" class="headerlink" title="Job 任务"></a>Job 任务</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rq <span class="keyword">import</span> get_current_job</span><br><span class="line"><span class="comment"># 任务除了可以通过enqueue入队，也可以使用类似于celery的task装饰器</span></span><br><span class="line"><span class="keyword">from</span> rq.decorators <span class="keyword">import</span> job</span><br><span class="line"></span><br><span class="line">host = <span class="string">"xxx.xxx.x.xxx"</span></span><br><span class="line">port = <span class="number">6379</span></span><br><span class="line">db = <span class="number">0</span></span><br><span class="line">redis_conn = Reids(host=host, port=port, db=db)</span><br><span class="line"></span><br><span class="line"><span class="meta">@job("myqueue", connection=redis_conn)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">foo</span><span class="params">(name)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">f"hello, <span class="subst">&#123;name&#125;</span>"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 或者</span></span><br><span class="line"><span class="comment"># q = Queue("myqueue", connection=redis_conn)</span></span><br><span class="line"><span class="comment"># @job(q)</span></span><br><span class="line"><span class="comment"># def foo(name):</span></span><br><span class="line"><span class="comment">#     return f"hello, &#123;name&#125;"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 执行任务 </span></span><br><span class="line">job = foo.delay(<span class="string">"world"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 或者直接从redis检索</span></span><br><span class="line"><span class="comment"># job = Job.fetch("job_id", connection=redis_conn)</span></span><br><span class="line"><span class="comment"># 也可以批量获取</span></span><br><span class="line"><span class="comment"># jobs = Job.fetch_many(["job_id1", "job_id2"], connection=redis_conn)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取任务id</span></span><br><span class="line">print(job.id)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取任务状态 可能的值有 queued, started, deferred, finished, failed</span></span><br><span class="line">print(job.get_status())</span><br><span class="line"></span><br><span class="line"><span class="comment"># 任务函数名</span></span><br><span class="line">print(job.func_name)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 任务函数位置参数</span></span><br><span class="line">print(job.args)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 任务函数关键字参数</span></span><br><span class="line">print(job.kwargs)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取返回值 完成前将返回None 保存时间为500秒(可以通过result_ttl设置保存时间)</span></span><br><span class="line">print(job.result)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取异常信息(任务没有成功的情况下)</span></span><br><span class="line">print(job.exc_info)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 可以在函数内部获取当前任务实例</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">bar</span><span class="params">()</span>:</span></span><br><span class="line">    job = get_current_job()</span><br><span class="line">    <span class="comment"># 通过meta属性可以存储自定义数据</span></span><br><span class="line">    job.meta[<span class="string">"name"</span>] = <span class="string">"world"</span></span><br><span class="line">    job.save_meta()</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"Bar"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 任务依赖 job2将会在job1完成时入队</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">job1</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">"job1 ok"</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">job2</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">"job2 ok"</span></span><br><span class="line"></span><br><span class="line">job_1 = q.enqueue(job1)</span><br><span class="line">q.enqueue(job2, depends_on=job_1)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 任务失败将默认放入FailedJobRegistry</span></span><br><span class="line"><span class="keyword">from</span> rq <span class="keyword">import</span> Worker</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test</span><span class="params">()</span>:</span></span><br><span class="line">    print(<span class="number">1</span>/<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">test_job = q.enqueue(test)</span><br><span class="line">worker = Worker([queue])</span><br><span class="line">worker.work(burst=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">print(test_job.is_failed) <span class="comment"># True</span></span><br><span class="line"></span><br><span class="line">registry = queue.failed_job_registry</span><br><span class="line"><span class="keyword">assert</span> len(registry) == <span class="number">1</span> </span><br><span class="line"><span class="comment"># 重新入队</span></span><br><span class="line">registry.requeue(test_job)</span><br><span class="line"><span class="keyword">assert</span> len(registry) == <span class="number">0</span></span><br><span class="line"><span class="keyword">assert</span> queue.count == <span class="number">1</span></span><br><span class="line"><span class="comment"># 或者通过CLI工具重新入队</span></span><br><span class="line"><span class="comment"># 通过任务id指定失败任务入队</span></span><br><span class="line"><span class="comment"># rq requeue --queue queue_name -u redis://localhost:6379 foo_job_id bar_job_id</span></span><br><span class="line"><span class="comment"># 全部失败任务重新入队</span></span><br><span class="line"><span class="comment"># rq requeue --queue queue_name -u redis://localhost:6379 --all</span></span><br></pre></td></tr></table></figure>

<h3 id="Worker-工作者"><a href="#Worker-工作者" class="headerlink" title="Worker 工作者"></a>Worker 工作者</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">// 启动一个工作者</span><br><span class="line">$ rq worker queue_name</span><br></pre></td></tr></table></figure>
<p>rq工作者每次只处理一个任务，如果要同时执行多个任务，可以开启多个工作者</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; 以Burst模式启动</span><br><span class="line">&#x2F;&#x2F; 默认启动方式在所有任务完成时将会阻塞等待新任务到来</span><br><span class="line">&#x2F;&#x2F; burst参数可以在所有任务完成时退出当前工作者</span><br><span class="line">$ rq -burst worker queue_name</span><br></pre></td></tr></table></figure>
<p>其他参数</p>
<ul>
<li>--url or -u: redis连接地址  (e.g rq worker --url redis://:secrets@example.com:1234/9 or rq worker --url unix:///var/run/redis/redis.sock)</li>
<li>--path or -P: 支持多个导入路径 (e.g rq worker --path foo --path bar)</li>
<li>--config or -c: RQ配置文件模块路径</li>
<li>--results-ttl: 任务结果存储秒数(默认为500秒)</li>
<li>--worker-class or -w: RQ Worker类 (e.g rq worker --worker-class ‘foo.bar.MyWorker’)</li>
<li>--job-class or -j: RQ Job类</li>
<li>--queue-class: RQ Queue类</li>
<li>--connection-class: redis连接类(默认为redis.StrictRedis)</li>
<li>--log-format: worker打印日志格式(默认为’%(asctime)s %(message)s’)</li>
<li>--date-format: worker打印日志日期格式(默认为’%H:%M:%S’)</li>
<li>--disable-job-desc-logging: 关闭任务描述日志</li>
<li>--max-jobs: 最大执行任务数</li>
</ul>
<h4 id="性能优化"><a href="#性能优化" class="headerlink" title="性能优化"></a>性能优化</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 如果你的任务都依赖于同一模块，则每次运行时worker都会fork子进程重新导入</span></span><br><span class="line"><span class="comment"># 这种方式不会发生内存泄露，但是速度很慢，你可以写一个辅助脚本预加载你需要导入的模块</span></span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">from</span> rq <span class="keyword">import</span> Connection, Worker</span><br><span class="line"></span><br><span class="line"><span class="comment"># 预加载模块</span></span><br><span class="line"><span class="keyword">import</span> preload_lib</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> Connection():</span><br><span class="line">    <span class="comment"># 从命令行传递队列名称 类似rq worker queue_name</span></span><br><span class="line">    qs = sys.argv[<span class="number">1</span>:] <span class="keyword">or</span> [<span class="string">"default"</span>]</span><br><span class="line"></span><br><span class="line">    w = Worker(qs)</span><br><span class="line">    w.work()</span><br></pre></td></tr></table></figure>

<h4 id="检索工作者信息"><a href="#检索工作者信息" class="headerlink" title="检索工作者信息"></a>检索工作者信息</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> redis <span class="keyword">import</span> Redis</span><br><span class="line"><span class="keyword">from</span> rq <span class="keyword">import</span> Queue, Worker</span><br><span class="line"></span><br><span class="line"><span class="comment"># 返回此连接中注册的所有工作者</span></span><br><span class="line">redis_conn = Redis()</span><br><span class="line">workers = Worker.all(connection=redis_conn)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 返回此队列中注册的所有工作者</span></span><br><span class="line">queue = Queue(<span class="string">'queue_name'</span>)</span><br><span class="line">workers = Worker.all(queue=queue)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 返回工作者数量</span></span><br><span class="line">print(Worker.count(connection=redis_conn))</span><br><span class="line">print(Worker.count(queue=queue))</span><br><span class="line"></span><br><span class="line">worker = workers[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 工作者名称</span></span><br><span class="line">print(worker.name)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 工作者当前主机名</span></span><br><span class="line">print(worker.hostname)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 工作者进程PID</span></span><br><span class="line">print(worker.pid)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 工作者当前监听队列</span></span><br><span class="line">print(worker.queues)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 工作者当前状态 suspended, started, busy, idle</span></span><br><span class="line">print(worker.state)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 工作者当前执行任务实例</span></span><br><span class="line">print(worker.current_job)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 工作者最后一次心跳</span></span><br><span class="line">print(worker.last_heartbeat)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 工作者创建时间</span></span><br><span class="line">print(worker.birth_date)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 工作者成功完成任务数</span></span><br><span class="line">print(worker.successful_job_count)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 工作者失败任务数</span></span><br><span class="line">print(worker.failed_job_count)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 工作者执行任务花费的时间(秒)</span></span><br><span class="line">print(worker.total_working_time)</span><br></pre></td></tr></table></figure>
<h4 id="使用配置文件"><a href="#使用配置文件" class="headerlink" title="使用配置文件"></a>使用配置文件</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">REDIS_URL = <span class="string">'redis://localhost:6379/1'</span></span><br><span class="line"><span class="comment"># You can also specify the Redis DB to use</span></span><br><span class="line"><span class="comment"># REDIS_HOST = 'redis.example.com'</span></span><br><span class="line"><span class="comment"># REDIS_PORT = 6380</span></span><br><span class="line"><span class="comment"># REDIS_DB = 3</span></span><br><span class="line"><span class="comment"># REDIS_PASSWORD = 'very secret'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Queues to listen on</span></span><br><span class="line">QUEUES = [<span class="string">'high'</span>, <span class="string">'default'</span>, <span class="string">'low'</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># If you're using Sentry to collect your runtime exceptions, you can use this</span></span><br><span class="line"><span class="comment"># to configure RQ for it in a single step</span></span><br><span class="line"><span class="comment"># The 'sync+' prefix is required for raven: https://github.com/nvie/rq/issues/350#issuecomment-43592410</span></span><br><span class="line">SENTRY_DSN = <span class="string">'sync+http://public:secret@example.com/1'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># If you want custom worker name</span></span><br><span class="line"><span class="comment"># NAME = 'worker-1024'</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ rq worker -c settings</span><br></pre></td></tr></table></figure>
<h4 id="无工作者模式"><a href="#无工作者模式" class="headerlink" title="无工作者模式"></a>无工作者模式</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># is_async=False开启无工作者模式，代码将会以同步方式运行，可以用作测试</span></span><br><span class="line"><span class="comment"># 但redis连接是必须要传的，用以存储任务完成的相关状态</span></span><br><span class="line"><span class="keyword">from</span> redis <span class="keyword">import</span> Redis</span><br><span class="line"><span class="keyword">from</span> rq <span class="keyword">import</span> Queue, Worker</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">foo</span><span class="params">()</span>:</span></span><br><span class="line">    print(<span class="string">"foo"</span>)</span><br><span class="line"></span><br><span class="line">redis_conn = Redis()</span><br><span class="line">q = Queue(<span class="string">"queue_name"</span>, is_async=<span class="literal">False</span>, connection=redis_conn)</span><br><span class="line">job = q.enqueue(foo)</span><br><span class="line">print(job.result)</span><br></pre></td></tr></table></figure>

<h3 id="Scheduler-调度器"><a href="#Scheduler-调度器" class="headerlink" title="Scheduler 调度器"></a>Scheduler 调度器</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime, timedelta</span><br><span class="line"><span class="keyword">from</span> rq <span class="keyword">import</span> Queue</span><br><span class="line"><span class="keyword">from</span> rq.registry <span class="keyword">import</span> ScheduledJobRegistry</span><br><span class="line"><span class="keyword">from</span> redis <span class="keyword">import</span> Redis</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">foo</span><span class="params">()</span>:</span></span><br><span class="line">    print(<span class="string">"hi"</span>)</span><br><span class="line"></span><br><span class="line">q = Queue(name=<span class="string">"default"</span>, connection=Redis())</span><br><span class="line"></span><br><span class="line"><span class="comment"># 任务将在本地时区2020年6月24日9点57分执行</span></span><br><span class="line">job = q.enqueue(datetime(<span class="number">2020</span>, <span class="number">6</span>, <span class="number">24</span>, <span class="number">9</span>, <span class="number">57</span>), foo)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 任务将在10秒内执行</span></span><br><span class="line">job = q.enqueue(timedelta(seconds=<span class="number">10</span>), foo)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 计划执行的任务不会放入队列，而是存储在ScheduledJobRegistry中</span></span><br><span class="line">print(job <span class="keyword">in</span> q) <span class="comment"># False</span></span><br><span class="line"></span><br><span class="line">registry = ScheduledJobRegistry(queue=queue)</span><br><span class="line">print(job <span class="keyword">in</span> registry) <span class="comment"># True</span></span><br></pre></td></tr></table></figure>
<p>运行调度器</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ rq worker --with-scheduler</span><br></pre></td></tr></table></figure>
<p>通过代码运行</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rq <span class="keyword">import</span> Worker, Queue</span><br><span class="line"><span class="keyword">from</span> redis <span class="keyword">import</span> Redis</span><br><span class="line"></span><br><span class="line">redis = Redis()</span><br><span class="line"></span><br><span class="line">queue = Queue(connection=redis)</span><br><span class="line">worker = Worker(queues=[queue], connection=redis)</span><br><span class="line">worker.work(with_scheduler=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>

<h3 id="Connections-连接"><a href="#Connections-连接" class="headerlink" title="Connections 连接"></a>Connections 连接</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 单redis连接</span></span><br><span class="line"><span class="comment"># 已弃用 不要用在开发环境</span></span><br><span class="line"><span class="keyword">from</span> rq <span class="keyword">import</span> use_connection</span><br><span class="line"><span class="comment"># 会使用一个本地redis连接(全局)</span></span><br><span class="line">use_connection()</span><br><span class="line"><span class="comment"># or</span></span><br><span class="line"><span class="comment"># redis = Redis('my.host.org', 6789, password='secret')</span></span><br><span class="line"><span class="comment"># use_connection(redis)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 多redis连接</span></span><br><span class="line"><span class="keyword">from</span> rq <span class="keyword">import</span> Queue</span><br><span class="line"><span class="keyword">from</span> redis <span class="keyword">import</span> Redis</span><br><span class="line"></span><br><span class="line">conn1 = Redis(<span class="string">'localhost'</span>, <span class="number">6379</span>)</span><br><span class="line">conn2 = Redis(<span class="string">'remote.host.org'</span>, <span class="number">9836</span>)</span><br><span class="line"></span><br><span class="line">q1 = Queue(<span class="string">'foo'</span>, connection=conn1)</span><br><span class="line">q2 = Queue(<span class="string">'bar'</span>, connection=conn2)</span><br><span class="line"></span><br><span class="line"><span class="comment"># or </span></span><br><span class="line"><span class="comment"># 将使用上下文内的redis连接</span></span><br><span class="line"><span class="comment"># with Connection(Redis('localhost', 6379)):</span></span><br><span class="line"><span class="comment">#     q1 = Queue('foo')</span></span><br><span class="line"><span class="comment">#     with Connection(Redis('remote.host.org', 9836)):</span></span><br><span class="line"><span class="comment">#         q2 = Queue('bar')</span></span><br><span class="line"><span class="comment">#     q3 = Queue('qux')</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 单元测试可以使用push_connection()和pop_connection()</span></span><br><span class="line"><span class="keyword">import</span> unittest</span><br><span class="line"><span class="keyword">from</span> rq <span class="keyword">import</span> push_connection, pop_connection</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyTest</span><span class="params">(unittest.TestCase)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">setUp</span><span class="params">(self)</span>:</span></span><br><span class="line">        push_connection(Redis())</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">tearDown</span><span class="params">(self)</span>:</span></span><br><span class="line">        pop_connection()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">test_foo</span><span class="params">(self)</span>:</span></span><br><span class="line">        q = Queue()</span><br></pre></td></tr></table></figure>

<h3 id="Job-Registries-任务注册表"><a href="#Job-Registries-任务注册表" class="headerlink" title="Job Registries 任务注册表"></a>Job Registries 任务注册表</h3><p>每个队列都会维护一组任务注册表</p>
<ul>
<li>StartedJobRegistry 保存当前正在执行的任务。任务在执行前添加，完成(成功或失败)后被删除。</li>
<li>FinishedJobRegistry 保存成功执行的任务。</li>
<li>FailedJobRegistry 保存完成但失败的任务。</li>
<li>DeferredJobRegistry 保存延迟任务(依赖任务)。</li>
<li>ScheduledJobRegistry 保存计划任务。<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> redis <span class="keyword">import</span> Redis</span><br><span class="line"><span class="keyword">from</span> rq <span class="keyword">import</span> Queue</span><br><span class="line"><span class="keyword">from</span> rq.registry <span class="keyword">import</span> StartedJobRegistry</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">foo</span><span class="params">()</span>:</span></span><br><span class="line">    print(<span class="string">"foo"</span>)</span><br><span class="line"></span><br><span class="line">redis = Redis()</span><br><span class="line">queue = Queue(<span class="string">"queue_name"</span>, connection=redis)</span><br><span class="line">job = queue.enqueue(foo)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 根据队列实例获取队列StartedJobRegistry</span></span><br><span class="line">registry1 = StartedJobRegistry(queue=queue)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 根据队列名称和连接获取队列StartedJobRegistry</span></span><br><span class="line">registry2 = StartedJobRegistry(name=<span class="string">"queue_name"</span>, connection=redis)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取队列实例</span></span><br><span class="line">print(registry1.get_queue())</span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取注册表任务数</span></span><br><span class="line">print(registry1.count)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取注册表所有任务ID</span></span><br><span class="line">print(registry1.get_job_ids())</span><br><span class="line"></span><br><span class="line"><span class="comment"># 判断任务是否存在注册表中</span></span><br><span class="line"><span class="comment"># 实例判断</span></span><br><span class="line">print(job <span class="keyword">in</span> registry1)</span><br><span class="line"><span class="comment"># id判断</span></span><br><span class="line">print(job.id <span class="keyword">in</span> registry1)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 也可以直接从队列中访问注册表</span></span><br><span class="line">print(queue.started_job_registry) <span class="comment"># 返回StartedJobRegistry</span></span><br><span class="line">print(queue.deferred_job_registry) <span class="comment"># 返回DeferredJobRegistry</span></span><br><span class="line">print(queue.finished_job_registry) <span class="comment"># 返回FinishedJobRegistry</span></span><br><span class="line">print(queue.failed_job_registry) <span class="comment"># 返回FailedJobRegistry</span></span><br><span class="line">print(queue.scheduled_job_registry) <span class="comment"># 返回ScheduledJobRegistry</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除作业</span></span><br><span class="line"><span class="keyword">from</span> rq.registry <span class="keyword">import</span> FailedJobRegistry</span><br><span class="line">faild_registry = FailedJobRegistry(queue=queue)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> job_id <span class="keyword">in</span> faild_registry.get_job_ids():</span><br><span class="line">    faild_registry.remove(job_id)</span><br><span class="line">    <span class="comment"># 删除作业并从队列中删除</span></span><br><span class="line">    <span class="comment"># faild_registry.remove(job_id, delete_job=True)</span></span><br></pre></td></tr></table></figure>

</li>
</ul>
<h3 id="Serialize-序列化"><a href="#Serialize-序列化" class="headerlink" title="Serialize 序列化"></a>Serialize 序列化</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 自定义序列化器至少具有loads和dumps函数 </span></span><br><span class="line"><span class="comment"># 默认的序列化器为pickle</span></span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">from</span> rq <span class="keyword">import</span> Job, Queue, Worker</span><br><span class="line"></span><br><span class="line"><span class="comment"># 自定义任务序列化器</span></span><br><span class="line">job = Job(connection=connection, serializer=json)</span><br><span class="line"><span class="comment"># 自定义队列序列化器</span></span><br><span class="line">queue = Queue(connection=connection, serializer=json)</span><br><span class="line"><span class="comment"># 自定义工作者序列化器</span></span><br><span class="line">worker = Worker(queue, serializer=json)</span><br></pre></td></tr></table></figure>

<h3 id="Monitoring-监控"><a href="#Monitoring-监控" class="headerlink" title="Monitoring 监控"></a>Monitoring 监控</h3><h4 id="使用RQ-dashboard"><a href="#使用RQ-dashboard" class="headerlink" title="使用RQ dashboard"></a>使用RQ dashboard</h4><p><a href="https://github.com/Parallels/rq-dashboard" target="_blank" rel="noopener">RQ dashboard</a><br><img src="https://python-rq.org/img/dashboard.png" alt=""></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ pip install rq-dashboard</span><br><span class="line">$ rq-dashboard</span><br></pre></td></tr></table></figure>
<h4 id="使用CLI工具"><a href="#使用CLI工具" class="headerlink" title="使用CLI工具"></a>使用CLI工具</h4><p>rq info 命令</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">$ rq info -u redis://127.0.0.1:6379/1 </span><br><span class="line">cost         | 0</span><br><span class="line">mailbox      | 0</span><br><span class="line">2 queues, 0 <span class="built_in">jobs</span> total</span><br><span class="line"></span><br><span class="line">8e006dec6d0146f392ab624af6cbb738 (root 21767): idle cost</span><br><span class="line">a2a1ecde7c934e3ba6751bffc499e4f4 (root 44482): idle mailbox</span><br><span class="line">2 workers, 2 queues</span><br><span class="line"></span><br><span class="line">Updated: 2020-06-24 10:58:51.994777</span><br><span class="line">``` </span><br><span class="line">指定队列名称</span><br><span class="line">```bash</span><br><span class="line">$ rq info cost -u redis://127.0.0.1:6379/1 </span><br><span class="line">cost         | 0</span><br><span class="line">1 queues, 0 <span class="built_in">jobs</span> total</span><br><span class="line"></span><br><span class="line">8e006dec6d0146f392ab624af6cbb738 (root 21767): idle cost</span><br><span class="line">1 workers, 1 queues</span><br><span class="line"></span><br><span class="line">Updated: 2020-06-24 10:59:06.786965</span><br></pre></td></tr></table></figure>
<p>按队列分组</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ rq info -R -u redis://127.0.0.1:6379/1 </span><br><span class="line">cost         | 0</span><br><span class="line">mailbox      | 0</span><br><span class="line">2 queues, 0 <span class="built_in">jobs</span> total</span><br><span class="line"></span><br><span class="line">cost:    8e006dec6d0146f392ab624af6cbb738 (idle)</span><br><span class="line">mailbox: a2a1ecde7c934e3ba6751bffc499e4f4 (idle)</span><br><span class="line">2 workers, 2 queues</span><br><span class="line"></span><br><span class="line">Updated: 2020-06-24 11:02:58.784870</span><br></pre></td></tr></table></figure>
<p>间隔轮询(默认rq info命令打印一次信息就会退出，加上interval参数将会每隔N秒刷新一次屏幕)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ rq info --interval 1</span><br></pre></td></tr></table></figure>

<h3 id="Exceptions-异常处理"><a href="#Exceptions-异常处理" class="headerlink" title="Exceptions 异常处理"></a>Exceptions 异常处理</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 默认异常处理机制是存入FailedJobRegistry</span></span><br><span class="line"><span class="comment"># 可以自定义异常处理程序</span></span><br><span class="line"><span class="keyword">from</span> redis <span class="keyword">import</span> Redis</span><br><span class="line"><span class="keyword">from</span> rq <span class="keyword">import</span> Queue, Worker</span><br><span class="line"><span class="keyword">from</span> exception_handlers <span class="keyword">import</span> foo_handler, bar_handler</span><br><span class="line"></span><br><span class="line"><span class="comment"># rq异常处理为链式处理</span></span><br><span class="line"><span class="comment"># 当其中一个异常处理程序返回False时，后面的异常处理程序将不会执行</span></span><br><span class="line"><span class="comment"># 没有返回值时，将被解释为True，继续执行后面的异常处理程序</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">my_handler</span><span class="params">(job, exc_type, exc_value, traceback)</span>:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">q = Queue(connection=Redis())</span><br><span class="line">w = Worker([q], exception_handlers=[foo_handler, bar_handler, my_handler])</span><br></pre></td></tr></table></figure>

<h3 id="单元测试"><a href="#单元测试" class="headerlink" title="单元测试"></a>单元测试</h3><p> <a href="https://python-rq.org/docs/testing/" target="_blank" rel="noopener">👉</a></p>
<h3 id="Flask中使用RQ添加上下文"><a href="#Flask中使用RQ添加上下文" class="headerlink" title="Flask中使用RQ添加上下文"></a>Flask中使用RQ添加上下文</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> redis <span class="keyword">import</span> Redis</span><br><span class="line"><span class="keyword">from</span> rq <span class="keyword">import</span> Queue, Job</span><br><span class="line"><span class="keyword">from</span> flask.cli <span class="keyword">import</span> ScriptInfo</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FlaskRqJob</span><span class="params">(Job)</span>:</span></span><br><span class="line">    <span class="string">'''</span></span><br><span class="line"><span class="string">    自定义Job类 添加flask上下文</span></span><br><span class="line"><span class="string">    需要设置FLASK_APP环境变量</span></span><br><span class="line"><span class="string">    '''</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, *args, **kwargs)</span>:</span></span><br><span class="line">        super().__init__(*args, **kwargs)</span><br><span class="line">        self.script_info = ScriptInfo()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">perform</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> current_app:</span><br><span class="line">            app = current_app</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            app = self.script_info.load_app()</span><br><span class="line">        <span class="keyword">with</span> app.app_context():</span><br><span class="line">            <span class="keyword">return</span> super().perform()</span><br><span class="line"></span><br><span class="line">q = Queue(name=<span class="string">"queue_name"</span>, connection=Redis(), job_class=FlaskRqJob)</span><br></pre></td></tr></table></figure>
<p>运行worker时也要指定相应job class，且需要指定flask app路径(设置FLASK_APP环境变量)</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">export</span> FLASK_APP=app:app</span><br><span class="line">$ rq worker -j package.module.FlaskRqJob</span><br></pre></td></tr></table></figure>
</div><div class="tags"></div></section></div><div class="container"><ul class="nav"><li>下一篇：<a href="/2020/06/21/%E5%9B%BD%E5%86%85%E5%AE%89%E8%A3%85VSCode-Golang%E6%89%A9%E5%B1%95%E8%B6%85%E6%97%B6-timeout-%E9%97%AE%E9%A2%98%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95/">国内安装VSCode Golang扩展超时(timeout)问题解决方法</a></li></ul></div><div id="backToTop"><div class="back-arrow back-arrow-left"></div><div class="back-arrow back-arrow-right"></div></div><footer class="container"><div class="rights"><div> <a href="http://www.beian.miit.gov.cn/" target="_blank">粤ICP备20040793号</a></div><span>Powered by </span><a href="http://hexo.io" target="_blank">Hexo</a><span>, Theme </span><a href="https://github.com/gary-Shen/hexo-theme-bear" target="_blank">Bear</a><span>.</span></div></footer>
<script src="/script/jquery.min.js"></script>

<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">

<script src="/fancybox/jquery.fancybox.pack.js"></script>

<script src="/script/index.js"></script>

<script src="/script/post.js"></script>
</body></html>